CREATE OR REPLACE VIEW %dbprefix%view_total_payment AS SELECT sum(pay_amount) as pay_amount,bill_id FROM %dbprefix%payment GROUP BY bill_id
CREATE OR REPLACE VIEW %dbprefix%view_bill AS SELECT bill.bill_id,bill.bill_date,bill.visit_id,users.name AS doctor_name,visit.userid,patient.patient_id,patient.display_id,contacts.first_name,contacts.middle_name,contacts.last_name,bill.total_amount,bill.due_amount,IFNULL(payment.pay_amount,0) AS pay_amount FROM %dbprefix%bill AS bill JOIN %dbprefix%visit AS visit ON bill.visit_id = visit.visit_id JOIN %dbprefix%users AS users ON visit.userid = users.userid JOIN %dbprefix%patient AS patient ON bill.patient_id = patient.patient_id LEFT JOIN %dbprefix%view_total_payment AS payment ON payment.bill_id = bill.bill_id JOIN %dbprefix%contacts AS contacts ON contacts.contact_id = patient.contact_id;
CREATE OR REPLACE VIEW %dbprefix%view_report AS SELECT appointment.appointment_id,appointment.patient_id,CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''), ' ',IFNULL(view_patient.last_name,'')) as patient_name,appointment.userid,users.name doctor_name,appointment.appointment_date,min(appointment.start_time) as appointment_time,max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END) as waiting_in,(max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END) - max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END)) as waiting_duration, max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END) as consultation_in,max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END) as consultation_out, (max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END) - max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) as consultation_duration, max(CASE appointment_log.old_status WHEN 'Consultation' THEN timediff(appointment_log.to_time,appointment_log.from_time) END) as waiting_out, max(bill.total_amount) as collection_amount FROM  %dbprefix%appointments as appointment LEFT JOIN %dbprefix%view_patient as view_patient ON appointment.patient_id = view_patient.patient_id 	   LEFT JOIN %dbprefix%bill as bill ON appointment.visit_id = bill.visit_id 	   LEFT JOIN %dbprefix%appointment_log as appointment_log ON appointment.appointment_id = appointment_log.appointment_id	   LEFT JOIN %dbprefix%users AS users ON users.userid = appointment.userid GROUP BY appointment.appointment_id,patient_name;
UPDATE %dbprefix%version SET current_version='0.2.5';
